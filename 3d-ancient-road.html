<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>京藏古道3D可视化与虚拟漫游</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
            max-width: 320px;
        }
        
        #controls h3 {
            margin-top: 0;
            color: #8B4513;
            font-size: 18px;
            border-bottom: 2px solid #8B4513;
            padding-bottom: 10px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            pointer-events: auto;
        }
        
        .btn:hover {
            background-color: #6B340F;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
            max-width: 450px;
        }
        
        #info-panel h3 {
            margin-top: 0;
            color: #8B4513;
            font-size: 18px;
        }
        
        #info-panel p {
            margin: 10px 0;
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }
        
        #position-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
            font-size: 14px;
            color: #333;
        }
        
        #position-info div {
            margin-bottom: 5px;
        }
        
        #position-info strong {
            color: #8B4513;
        }
        
        .waypoint-list {
            margin-top: 15px;
        }
        
        .waypoint-btn {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        .waypoint-btn:hover {
            background-color: #e8e8e8;
            border-color: #8B4513;
        }
        
        .waypoint-btn.active {
            background-color: #8B4513;
            color: white;
            border-color: #8B4513;
        }
        
        #status-bar {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: auto;
        }
        
        #progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 5;
        }
        
        #progress-fill {
            height: 100%;
            background-color: #8B4513;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- 3D场景容器 -->
    <div id="canvas-container"></div>
    
    <!-- 进度条 -->
    <div id="progress-bar">
        <div id="progress-fill"></div>
    </div>
    
    <!-- UI容器 -->
    <div id="ui-container">
        <!-- 位置信息 -->
        <div id="position-info">
            <div><strong>当前位置:</strong> <span id="current-position">北京</span></div>
            <div><strong>海拔:</strong> <span id="current-altitude">50</span> 米</div>
            <div><strong>已行距离:</strong> <span id="current-distance">0</span> 公里</div>
            <div><strong>总距离:</strong> <span id="total-distance">3800</span> 公里</div>
        </div>
        
        <!-- 控制面板 -->
        <div id="controls">
            <h3>漫游控制</h3>
            <div class="control-group">
                <label for="speed">漫游速度</label>
                <input type="range" id="speed" min="0.5" max="10" step="0.5" value="3">
            </div>
            <div class="control-group">
                <label for="view-mode">视角模式</label>
                <select id="view-mode">
                    <option value="first-person">第一人称</option>
                    <option value="third-person">第三人称</option>
                    <option value="top-down">俯视图</option>
                    <option value="cinematic"> cinematic</option>
                </select>
            </div>
            <div class="control-group">
                <label for="weather">天气效果</label>
                <select id="weather">
                    <option value="clear">晴天</option>
                    <option value="cloudy">多云</option>
                    <option value="rainy">雨天</option>
                    <option value="snowy">雪天</option>
                </select>
            </div>
            <button class="btn" id="start-btn">开始漫游</button>
            <button class="btn" id="pause-btn">暂停</button>
            <button class="btn" id="reset-btn">重置</button>
            
            <h3>路点导航</h3>
            <div class="waypoint-list" id="waypoints"></div>
        </div>
        
        <!-- 信息面板 -->
        <div id="info-panel">
            <h3 id="location-name">北京</h3>
            <p id="location-description">北京是京藏古道的起点，元代称大都，是当时的政治、经济和文化中心。从这里出发，古道穿越华北平原，进入山西高原，然后沿黄河而上，经过甘肃、青海，最终到达西藏拉萨。</p>
            <p id="historical-info">元代时期，北京作为大都，是蒙古帝国的政治中心。忽必烈建立元朝后，为了加强对西藏的管理，修建了这条连接北京与西藏的驿路，成为两地政治、经济、文化交流的重要通道。</p>
        </div>
        
        <!-- 状态栏 -->
        <div id="status-bar">
            <span id="status-text">就绪</span>
        </div>
    </div>

    <!-- Three.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // 场景数据 - AI生成的模拟数据
        const routeData = {
            name: "京藏古道",
            start: "北京",
            end: "拉萨",
            totalLength: 3800,
            waypoints: [
                {
                    id: 1,
                    name: "北京",
                    description: "北京是京藏古道的起点，元代称大都，是当时的政治、经济和文化中心。",
                    historicalInfo: "元代时期，北京作为大都，是蒙古帝国的政治中心。忽必烈建立元朝后，为了加强对西藏的管理，修建了这条连接北京与西藏的驿路。",
                    coordinates: { x: 0, y: 0, z: 0 },
                    altitude: 50,
                    distanceFromStart: 0
                },
                {
                    id: 2,
                    name: "大同",
                    description: "大同是山西省北部的重要城市，位于内外长城之间，是京藏古道上的重要驿站。",
                    historicalInfo: "元代时期，大同是连接中原与草原的重要枢纽，也是京藏古道上的重要补给点。这里保存有许多元代的历史遗迹。",
                    coordinates: { x: 200, y: 50, z: 50 },
                    altitude: 1000,
                    distanceFromStart: 300
                },
                {
                    id: 3,
                    name: "呼和浩特",
                    description: "呼和浩特是内蒙古自治区的首府，位于京藏古道的重要节点上。",
                    historicalInfo: "元代时期，呼和浩特一带是蒙古草原与中原地区的过渡地带，是京藏古道上的重要牧区驿站。",
                    coordinates: { x: 400, y: 100, z: 100 },
                    altitude: 1050,
                    distanceFromStart: 600
                },
                {
                    id: 4,
                    name: "银川",
                    description: "银川是宁夏回族自治区的首府，位于黄河岸边，是京藏古道上的重要城市。",
                    historicalInfo: "元代时期，银川是控制西北边疆的重要军事据点，也是京藏古道上的重要补给站。",
                    coordinates: { x: 600, y: 150, z: 150 },
                    altitude: 1100,
                    distanceFromStart: 900
                },
                {
                    id: 5,
                    name: "兰州",
                    description: "兰州是甘肃省的省会，位于黄河上游，是京藏古道上的重要枢纽。",
                    historicalInfo: "元代时期，兰州是连接中原与西域的重要城市，也是京藏古道上的重要物资集散地。",
                    coordinates: { x: 800, y: 200, z: 200 },
                    altitude: 1500,
                    distanceFromStart: 1200
                },
                {
                    id: 6,
                    name: "西宁",
                    description: "西宁是青海省的省会，位于青藏高原的东部边缘，是京藏古道进入高原的门户。",
                    historicalInfo: "元代时期，西宁是控制青藏高原东部的重要城市，也是京藏古道上的重要宗教中心。",
                    coordinates: { x: 1000, y: 300, z: 250 },
                    altitude: 2200,
                    distanceFromStart: 1500
                },
                {
                    id: 7,
                    name: "格尔木",
                    description: "格尔木位于青海省西部，是京藏古道穿越柴达木盆地的重要驿站。",
                    historicalInfo: "元代时期，格尔木一带是连接青海与西藏的重要通道，虽然自然条件恶劣，但战略地位重要。",
                    coordinates: { x: 1200, y: 400, z: 300 },
                    altitude: 2800,
                    distanceFromStart: 2000
                },
                {
                    id: 8,
                    name: "那曲",
                    description: "那曲位于西藏自治区北部，是京藏古道上的重要牧区城市。",
                    historicalInfo: "元代时期，那曲是西藏北部的重要政治中心，也是京藏古道上的重要驿站。",
                    coordinates: { x: 1400, y: 500, z: 350 },
                    altitude: 4500,
                    distanceFromStart: 3000
                },
                {
                    id: 9,
                    name: "拉萨",
                    description: "拉萨是西藏自治区的首府，是京藏古道的终点，也是藏传佛教的圣地。",
                    historicalInfo: "元代时期，拉萨是西藏的政治、经济和文化中心，也是京藏古道的最终目的地。萨迦派在元朝时期获得了特殊地位。",
                    coordinates: { x: 1600, y: 450, z: 400 },
                    altitude: 3650,
                    distanceFromStart: 3800
                }
            ]
        };

        // 3D场景初始化
        let scene, camera, renderer, controls, animationId, sky;
        let isRoaming = false;
        let currentWaypointIndex = 0;
        let currentPosition = { x: 0, y: 0, z: 0 };
        let speed = 3;
        let viewMode = 'first-person';
        let weather = 'clear';
        let particles = null;

        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // 创建相机
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            camera.position.set(0, 2, 5);

            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 添加灯光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 5000;
            scene.add(directionalLight);

            // 创建天空盒
            const skyGeometry = new THREE.SphereGeometry(10000, 32, 32);
            const skyMaterial = new THREE.MeshBasicMaterial({
                color: 0x87CEEB,
                side: THREE.BackSide
            });
            const sky = new THREE.Mesh(skyGeometry, skyMaterial);
            scene.add(sky);

            // 创建地形
            createTerrain();

            // 创建古道
            createRoad();

            // 创建建筑物
            createBuildings();

            // 创建自然景观
            createNature();

            // 创建控件
            createControls();

            // 添加路标点
            addWaypoints();

            // 初始化天气效果
            updateWeather();

            // 窗口大小调整
            window.addEventListener('resize', onWindowResize, false);

            // 开始动画
            animate();
        }

        // 创建地形
        function createTerrain() {
            const geometry = new THREE.PlaneGeometry(4000, 2000, 200, 200);
            
            // 生成地形高度
            for (let i = 0; i < geometry.vertices.length; i++) {
                const vertex = geometry.vertices[i];
                // 基础高度
                let height = 0;
                
                // 添加山脉
                if (vertex.x > 800) {
                    height = Math.sin(vertex.x * 0.001) * 200 + Math.cos(vertex.z * 0.001) * 100;
                    if (vertex.x > 1200) {
                        height += 200 + Math.sin(vertex.x * 0.0005) * 100;
                    }
                }
                
                vertex.y = height;
            }
            
            geometry.verticesNeedUpdate = true;
            geometry.computeFaceNormals();
            geometry.computeVertexNormals();
            geometry.computeBoundingBox();
            
            // 创建地形材质
            const material = new THREE.MeshPhongMaterial({
                color: 0x88AA66,
                wireframe: false,
                side: THREE.DoubleSide,
                vertexColors: THREE.VertexColors
            });
            
            // 添加顶点颜色
            const colors = [];
            for (let i = 0; i < geometry.vertices.length; i++) {
                const vertex = geometry.vertices[i];
                let color;
                
                if (vertex.y < 100) {
                    color = new THREE.Color(0x88AA66); // 绿色 - 平原
                } else if (vertex.y < 300) {
                    color = new THREE.Color(0x779955); // 深绿色 - 丘陵
                } else {
                    color = new THREE.Color(0x668844); // 棕色 - 山地
                }
                
                colors.push(color.r, color.g, color.b);
            }
            geometry.colors = colors;
            geometry.colorsNeedUpdate = true;
            
            const terrain = new THREE.Mesh(geometry, material);
            terrain.rotation.x = -Math.PI / 2;
            terrain.position.y = -100;
            terrain.receiveShadow = true;
            scene.add(terrain);
        }

        // 创建古道
        function createRoad() {
            const points = [];
            
            // 从路点创建曲线
            routeData.waypoints.forEach(waypoint => {
                points.push(new THREE.Vector3(
                    waypoint.coordinates.x,
                    waypoint.coordinates.y,
                    waypoint.coordinates.z
                ));
            });
            
            const curve = new THREE.CatmullRomCurve3(points);
            
            const geometry = new THREE.TubeGeometry(curve, 2000, 5, 20, false);
            const material = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
            
            const road = new THREE.Mesh(geometry, material);
            road.castShadow = true;
            road.receiveShadow = true;
            scene.add(road);
        }

        // 创建建筑物
        function createBuildings() {
            // 为每个路点创建建筑物
            routeData.waypoints.forEach(waypoint => {
                const group = new THREE.Group();
                group.position.set(
                    waypoint.coordinates.x,
                    waypoint.coordinates.y,
                    waypoint.coordinates.z
                );
                
                // 创建不同类型的建筑物
                const buildingTypes = [
                    { width: 20, height: 15, depth: 20, color: 0xD2B48C },
                    { width: 15, height: 12, depth: 15, color: 0xA0522D },
                    { width: 25, height: 18, depth: 25, color: 0xCD853F }
                ];
                
                for (let i = 0; i < 8; i++) {
                    const type = buildingTypes[Math.floor(Math.random() * buildingTypes.length)];
                    const buildingGeometry = new THREE.BoxGeometry(type.width, type.height, type.depth);
                    const buildingMaterial = new THREE.MeshPhongMaterial({ color: type.color });
                    
                    const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                    building.position.set(
                        Math.random() * 60 - 30,
                        type.height / 2,
                        Math.random() * 60 - 30
                    );
                    building.castShadow = true;
                    building.receiveShadow = true;
                    group.add(building);
                }
                
                scene.add(group);
            });
        }

        // 创建自然景观
        function createNature() {
            // 创建树木
            for (let i = 0; i < 500; i++) {
                const treeGroup = new THREE.Group();
                
                // 树干
                const trunkGeometry = new THREE.CylinderGeometry(1, 1, 5, 8);
                const trunkMaterial = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
                const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
                trunk.position.y = 2.5;
                treeGroup.add(trunk);
                
                // 树冠
                const crownGeometry = new THREE.SphereGeometry(3, 8, 8);
                const crownMaterial = new THREE.MeshPhongMaterial({ color: 0x228B22 });
                const crown = new THREE.Mesh(crownGeometry, crownMaterial);
                crown.position.y = 7;
                treeGroup.add(crown);
                
                // 随机位置
                const x = Math.random() * 3800 - 100;
                const z = Math.random() * 1800 - 900;
                
                // 避免在道路上生成树木
                let onRoad = false;
                for (let j = 0; j < routeData.waypoints.length - 1; j++) {
                    const wp1 = routeData.waypoints[j];
                    const wp2 = routeData.waypoints[j + 1];
                    
                    const distance = distanceToLine(
                        x, z,
                        wp1.coordinates.x, wp1.coordinates.z,
                        wp2.coordinates.x, wp2.coordinates.z
                    );
                    
                    if (distance < 20) {
                        onRoad = true;
                        break;
                    }
                }
                
                if (!onRoad) {
                    treeGroup.position.set(x, 0, z);
                    treeGroup.scale.set(0.5 + Math.random() * 0.5, 0.5 + Math.random() * 0.5, 0.5 + Math.random() * 0.5);
                    scene.add(treeGroup);
                }
            }
        }

        // 计算点到线段的距离
        function distanceToLine(px, pz, x1, z1, x2, z2) {
            const A = px - x1;
            const B = pz - z1;
            const C = x2 - x1;
            const D = z2 - z1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, zz;
            
            if (param < 0) {
                xx = x1;
                zz = z1;
            } else if (param > 1) {
                xx = x2;
                zz = z2;
            } else {
                xx = x1 + param * C;
                zz = z1 + param * D;
            }
            
            const dx = px - xx;
            const dz = pz - zz;
            return Math.sqrt(dx * dx + dz * dz);
        }

        // 简单的第一人称控制
        let mouseX = 0, mouseY = 0;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        
        function createControls() {
            // 添加鼠标移动事件监听
            document.addEventListener('mousemove', onMouseMove, false);
            
            // 添加键盘事件监听
            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);
        }
        
        function onMouseMove(event) {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        }
        
        function onKeyDown(event) {
            switch (event.keyCode) {
                case 38: // 上箭头
                case 87: // W
                    moveForward = true;
                    break;
                case 40: // 下箭头
                case 83: // S
                    moveBackward = true;
                    break;
                case 37: // 左箭头
                case 65: // A
                    moveLeft = true;
                    break;
                case 39: // 右箭头
                case 68: // D
                    moveRight = true;
                    break;
            }
        }
        
        function onKeyUp(event) {
            switch (event.keyCode) {
                case 38: // 上箭头
                case 87: // W
                    moveForward = false;
                    break;
                case 40: // 下箭头
                case 83: // S
                    moveBackward = false;
                    break;
                case 37: // 左箭头
                case 65: // A
                    moveLeft = false;
                    break;
                case 39: // 右箭头
                case 68: // D
                    moveRight = false;
                    break;
            }
        }

        // 添加路标点
        function addWaypoints() {
            const waypointsContainer = document.getElementById('waypoints');
            
            routeData.waypoints.forEach((waypoint, index) => {
                const button = document.createElement('button');
                button.className = 'waypoint-btn';
                button.textContent = waypoint.name;
                button.addEventListener('click', () => {
                    currentWaypointIndex = index;
                    updatePosition(waypoint.coordinates);
                    updateInfoPanel(waypoint);
                    updateWaypointButtons();
                });
                waypointsContainer.appendChild(button);
            });
            
            updateWaypointButtons();
        }

        // 更新路点按钮状态
        function updateWaypointButtons() {
            const buttons = document.querySelectorAll('.waypoint-btn');
            buttons.forEach((btn, index) => {
                if (index === currentWaypointIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 更新位置
        function updatePosition(coordinates) {
            currentPosition = coordinates;
            camera.position.set(
                coordinates.x,
                coordinates.y + 2,
                coordinates.z + 5
            );
            
            // 更新位置信息
            document.getElementById('current-position').textContent = routeData.waypoints[currentWaypointIndex].name;
            document.getElementById('current-altitude').textContent = routeData.waypoints[currentWaypointIndex].altitude;
            document.getElementById('current-distance').textContent = routeData.waypoints[currentWaypointIndex].distanceFromStart;
            
            // 更新进度条
            const progress = (routeData.waypoints[currentWaypointIndex].distanceFromStart / routeData.totalLength) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        // 更新信息面板
        function updateInfoPanel(waypoint) {
            document.getElementById('location-name').textContent = waypoint.name;
            document.getElementById('location-description').textContent = waypoint.description;
            document.getElementById('historical-info').textContent = waypoint.historicalInfo;
        }

        // 更新天气效果
        function updateWeather() {
            // 移除现有的粒子系统
            if (particles) {
                scene.remove(particles);
                particles = null;
            }
            
            // 更新天空颜色
            if (weather === 'cloudy') {
                scene.background = new THREE.Color(0xCCCCCC);
                if (sky) sky.material.color.set(0xCCCCCC);
            } else {
                scene.background = new THREE.Color(0x87CEEB);
                if (sky) sky.material.color.set(0x87CEEB);
            }
            
            // 根据天气类型创建粒子系统
            if (weather === 'rainy') {
                createRain();
            } else if (weather === 'snowy') {
                createSnow();
            }
        }

        // 创建雨效果
        function createRain() {
            const particlesGeometry = new THREE.Geometry();
            
            for (let i = 0; i < 10000; i++) {
                const particle = new THREE.Vector3(
                    Math.random() * 4000 - 2000,
                    Math.random() * 1000 - 500,
                    Math.random() * 2000 - 1000
                );
                particle.velocity = new THREE.Vector3(0, -Math.random() * 10 - 5, 0);
                particlesGeometry.vertices.push(particle);
            }
            
            const particlesMaterial = new THREE.PointsMaterial({
                color: 0x4A90E2,
                size: 1,
                transparent: true,
                opacity: 0.8
            });
            
            particles = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particles);
        }

        // 创建雪效果
        function createSnow() {
            const particlesGeometry = new THREE.Geometry();
            
            for (let i = 0; i < 5000; i++) {
                const particle = new THREE.Vector3(
                    Math.random() * 4000 - 2000,
                    Math.random() * 1000 - 500,
                    Math.random() * 2000 - 1000
                );
                particle.velocity = new THREE.Vector3(
                    Math.random() * 2 - 1,
                    -Math.random() * 3 - 1,
                    Math.random() * 2 - 1
                );
                particlesGeometry.vertices.push(particle);
            }
            
            const particlesMaterial = new THREE.PointsMaterial({
                color: 0xFFFFFF,
                size: 2,
                transparent: true,
                opacity: 0.8
            });
            
            particles = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particles);
        }

        // 窗口大小调整
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // 动画
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // 更新粒子效果
            if (particles) {
                particles.geometry.vertices.forEach(particle => {
                    particle.add(particle.velocity);
                    
                    // 重置粒子位置
                    if (particle.y < -500) {
                        particle.y = 500;
                    }
                    if (weather === 'rainy') {
                        if (particle.x < -2000) particle.x = 2000;
                        if (particle.z < -1000) particle.z = 1000;
                    } else if (weather === 'snowy') {
                        if (particle.x < -2000) particle.x = 2000;
                        if (particle.x > 2000) particle.x = -2000;
                        if (particle.z < -1000) particle.z = 1000;
                        if (particle.z > 1000) particle.z = -1000;
                    }
                });
                particles.geometry.verticesNeedUpdate = true;
            }
            
            if (isRoaming) {
                // 计算下一位置
                if (currentWaypointIndex < routeData.waypoints.length - 1) {
                    const currentWaypoint = routeData.waypoints[currentWaypointIndex];
                    const nextWaypoint = routeData.waypoints[currentWaypointIndex + 1];
                    
                    // 计算方向向量
                    const direction = new THREE.Vector3(
                        nextWaypoint.coordinates.x - currentWaypoint.coordinates.x,
                        nextWaypoint.coordinates.y - currentWaypoint.coordinates.y,
                        nextWaypoint.coordinates.z - currentWaypoint.coordinates.z
                    );
                    
                    const distance = direction.length();
                    direction.normalize();
                    
                    // 更新位置
                    currentPosition.x += direction.x * speed;
                    currentPosition.y += direction.y * speed;
                    currentPosition.z += direction.z * speed;
                    
                    // 更新相机位置
                    camera.position.set(
                        currentPosition.x,
                        currentPosition.y + 2,
                        currentPosition.z + 5
                    );
                    
                    // 朝向前进方向
                    const lookAt = new THREE.Vector3(
                        currentPosition.x + direction.x * 10,
                        currentPosition.y + 2,
                        currentPosition.z + direction.z * 10
                    );
                    camera.lookAt(lookAt);
                    
                    // 检查是否到达下一个路点
                    const currentDistance = new THREE.Vector3(
                        currentPosition.x - currentWaypoint.coordinates.x,
                        currentPosition.y - currentWaypoint.coordinates.y,
                        currentPosition.z - currentWaypoint.coordinates.z
                    ).length();
                    
                    if (currentDistance >= distance) {
                        currentWaypointIndex++;
                        updateInfoPanel(routeData.waypoints[currentWaypointIndex]);
                        updateWaypointButtons();
                        
                        // 更新位置信息
                        document.getElementById('current-position').textContent = routeData.waypoints[currentWaypointIndex].name;
                        document.getElementById('current-altitude').textContent = routeData.waypoints[currentWaypointIndex].altitude;
                        document.getElementById('current-distance').textContent = routeData.waypoints[currentWaypointIndex].distanceFromStart;
                        
                        // 更新进度条
                        const progress = (routeData.waypoints[currentWaypointIndex].distanceFromStart / routeData.totalLength) * 100;
                        document.getElementById('progress-fill').style.width = progress + '%';
                    }
                } else {
                    // 到达终点
                    isRoaming = false;
                    document.getElementById('start-btn').textContent = '开始漫游';
                    document.getElementById('status-text').textContent = '已到达终点: 拉萨';
                }
            } else {
                // 处理键盘控制
                const moveSpeed = 0.1;
                const direction = new THREE.Vector3();
                
                if (moveForward) direction.z -= moveSpeed;
                if (moveBackward) direction.z += moveSpeed;
                if (moveLeft) direction.x -= moveSpeed;
                if (moveRight) direction.x += moveSpeed;
                
                direction.normalize();
                
                // 更新相机位置
                camera.position.add(direction);
                
                // 更新鼠标视角
                camera.rotation.y += mouseX * 0.01;
                camera.rotation.x += mouseY * 0.01;
                
                // 限制垂直视角
                camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
            }
            
            renderer.render(scene, camera);
        }

        // 事件监听器
        document.getElementById('start-btn').addEventListener('click', function() {
            isRoaming = !isRoaming;
            this.textContent = isRoaming ? '停止漫游' : '开始漫游';
            document.getElementById('status-text').textContent = isRoaming ? '漫游中...' : '就绪';
        });

        document.getElementById('pause-btn').addEventListener('click', function() {
            isRoaming = false;
            document.getElementById('start-btn').textContent = '开始漫游';
            document.getElementById('status-text').textContent = '已暂停';
        });

        document.getElementById('reset-btn').addEventListener('click', function() {
            isRoaming = false;
            currentWaypointIndex = 0;
            updatePosition(routeData.waypoints[0].coordinates);
            updateInfoPanel(routeData.waypoints[0]);
            updateWaypointButtons();
            document.getElementById('start-btn').textContent = '开始漫游';
            document.getElementById('status-text').textContent = '已重置';
        });

        document.getElementById('speed').addEventListener('input', function() {
            speed = parseFloat(this.value);
        });

        document.getElementById('view-mode').addEventListener('change', function() {
            viewMode = this.value;
            // 这里可以添加不同视角模式的切换逻辑
        });

        document.getElementById('weather').addEventListener('change', function() {
            weather = this.value;
            updateWeather();
        });

        // 初始化场景
        init();
    </script>
</body>
</html>