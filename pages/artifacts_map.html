<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="全国著名古墓葬分布图，展示中国历史上重要古墓葬的地理位置和相关信息，结合时间轴展示墓葬的历史演变。">
    <meta name="keywords" content="古墓葬,分布图,历史文物,考古发现,时间轴,地理位置">
    <title>全国著名古墓葬分布图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/timeline.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- 顶部导航栏 -->
    <header>
        <div class="container">
            <div class="logo">
                <h1>京藏古道人文环境时空信息开放平台</h1>
                <p>元代北京至西藏的驿路文明</p>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">首页</a></li>
                    <li><a href="../index.html#explore">古道探索</a></li>
                    <li><a href="../index.html#map">地图展示</a></li>
                    <li><a href="../index.html#dataset">数据集</a></li>
                    <li><a href="culture.html">文化内涵</a></li>
                    <li><a href="travel.html">旅游攻略</a></li>
                    <li><a href="../index.html#about">关于平台</a></li>
                </ul>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="搜索...">
                    <button id="search-button"><i class="fas fa-search"></i></button>
                </div>
            </nav>
        </div>
    </header>

    <!-- 页面标题 -->
    <section class="page-header">
        <div class="container">
            <h1>全国著名古墓葬分布图</h1>
            <p>探索中国古代墓葬的分布与历史文化价值</p>
        </div>
    </section>

    <div class="container">
        <div class="search-map-controls">
            <form id="searchForm" class="d-flex mb-3">
                <input id="searchInput" class="form-control me-2" type="search" placeholder="输入古墓名称搜索" aria-label="搜索">
                <button class="btn-primary" type="submit">搜索</button>
            </form>
            <button id="filter-jingzang" class="btn-primary w-100 mb-2">显示京藏古道沿线墓葬</button>
            <button id="show-all" class="btn-secondary w-100">显示所有墓葬</button>
            <div id="searchAlert" class="mt-2 d-none alert alert-warning"></div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        const map = L.map('map').setView([35, 105], 4);
        L.tileLayer('https://webst0{s}.is.autonavi.com/appmaptile?style=7&x={x}&y={y}&z={z}', {
            subdomains: ['1','2','3','4'],
            attribution: '高德地图',
            detectRetina: true
        }).addTo(map);

        let relicsData = [];
        let routeData = null;
        let allMarkers = [];
        let routeLayers = [];

        async function loadCulturalRelics() {
            relicsData = await (await fetch('./json/cultural-relics.json')).json();
            return relicsData.filter(relic => 
                relic.longitude && relic.latitude &&
                !isNaN(relic.longitude) && !isNaN(relic.latitude)
            ).map(relic => ({
                ...relic,
                longitude: parseFloat(relic.longitude),
                latitude: parseFloat(relic.latitude)
            }));
        }

        async function loadRouteData() {
            routeData = await (await fetch('./json/route-data.json')).json();
            return routeData;
        }

        function createMarker(relic) {
            const marker = L.marker([relic.latitude, relic.longitude], {
                icon: L.icon({
                    iconUrl: './img/古墓.png',
                    iconSize: [32, 32],
                    popupAnchor: [0, -15]
                })
            });

            // 创建信息窗口模板
            marker.bindPopup(`
                <div class="info-window">
                    <h4>${relic.name || '未命名墓葬'}</h4>
                    <p>时代：${relic.era || '未知'}</p>
                    <p>批次：${relic.batch || '未知'}</p>
                    <p>地址：${relic.address || '地址不详'}</p>
                    ${relic.remarks ? `<p>简介：${relic.remarks}</p>` : ''}
                </div>
            `);

            return marker;
        }

        function haversineDistance(coords1, coords2) {
            const R = 6371; // 地球半径（公里）
            const dLat = (coords2.lat - coords1.lat) * Math.PI / 180;
            const dLng = (coords2.lng - coords1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(coords1.lat * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function isNearRoute(relic, maxDistance = 50) {
            if (!routeData) return false;

            // 检查是否靠近主线
            for (const point of routeData.mainRoute) {
                const distance = haversineDistance(
                    { lat: relic.latitude, lng: relic.longitude },
                    { lat: point[1], lng: point[0] }
                );
                if (distance < maxDistance) return true;
            }

            // 检查是否靠近支线
            for (const branch of routeData.branchRoutes) {
                for (const point of branch.path) {
                    const distance = haversineDistance(
                        { lat: relic.latitude, lng: relic.longitude },
                        { lat: point[1], lng: point[0] }
                    );
                    if (distance < maxDistance) return true;
                }
            }

            return false;
        }

        function clearAllMarkers() {
            allMarkers.forEach(marker => map.removeLayer(marker));
            allMarkers = [];
        }

        function clearRouteLayers() {
            routeLayers.forEach(layer => map.removeLayer(layer));
            routeLayers = [];
        }

        function drawRoutes() {
            if (!routeData) return;

            // 绘制主线
            const mainRouteLayer = L.polyline(
                routeData.mainRoute.map(point => [point[1], point[0]]),
                {
                    color: '#8B4513',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: ''
                }
            ).addTo(map);
            routeLayers.push(mainRouteLayer);

            // 为主线添加信息弹窗
            mainRouteLayer.bindPopup('京藏古道主线');

            // 绘制支线
            routeData.branchRoutes.forEach(branch => {
                const branchLayer = L.polyline(
                    branch.path.map(point => [point[1], point[0]]),
                    {
                        color: '#D2B48C',
                        weight: 3,
                        opacity: 0.6,
                        dashArray: '5, 5'
                    }
                ).addTo(map);
                routeLayers.push(branchLayer);

                // 为支线添加信息弹窗
                branchLayer.bindPopup(`${branch.name}<br>${branch.desc}`);
            });
        }

        function showAllTombs() {
            clearAllMarkers();
            clearRouteLayers();
            relicsData.forEach(relic => {
                const marker = createMarker(relic);
                marker.addTo(map);
                allMarkers.push(marker);
            });
            map.fitBounds(relicsData.map(r => [r.latitude, r.longitude]));
        }

        function showJingzangTombs() {
            clearAllMarkers();
            clearRouteLayers();
            const jingzangTombs = relicsData.filter(relic => isNearRoute(relic));
            jingzangTombs.forEach(relic => {
                const marker = createMarker(relic);
                marker.addTo(map);
                allMarkers.push(marker);
            });
            drawRoutes();
            if (jingzangTombs.length > 0) {
                map.fitBounds(jingzangTombs.map(r => [r.latitude, r.longitude]));
            } else {
                alert('未找到京藏古道沿线的墓葬');
            }
        }

        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const searchValue = document.getElementById('searchInput').value.trim();
            const foundRelic = relicsData.find(relic => 
                relic.name && relic.name.includes(searchValue)
            );

            if (foundRelic) {
                console.log('定位坐标：', foundRelic.latitude, foundRelic.longitude);
                map.flyTo([foundRelic.latitude, foundRelic.longitude], 15);
                const marker = createMarker(foundRelic);
                marker.addTo(map).openPopup();
            } else {
                const alertDiv = document.getElementById('searchAlert');
                alertDiv.textContent = searchValue ? '未找到匹配的古墓葬' : '请输入搜索内容';
                alertDiv.classList.remove('d-none');
                setTimeout(() => alertDiv.classList.add('d-none'), 2000);
            }
        });

        document.getElementById('filter-jingzang').addEventListener('click', showJingzangTombs);
        document.getElementById('show-all').addEventListener('click', showAllTombs);

        // 加载数据
        Promise.all([loadCulturalRelics(), loadRouteData()]).then(([relics, routes]) => {
            relicsData = relics;
            routeData = routes;
            console.log(`有效文物数据：${relics.length}`);
            console.log('路线数据加载完成');
            showAllTombs();
        }).catch(error => {
            console.error('数据加载失败:', error);
            alert('数据加载失败，请检查网络连接后刷新页面');
        });

    </script>
    <!-- 文物详情模态框 -->
<div id="relicsModal" class="custom-modal">
    <div class="custom-modal-overlay"></div>
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title"></h5>
                <button type="button" class="custom-modal-close">&times;</button>
            </div>
            <div class="custom-modal-body">
                <!-- 文物卡片动态加载 -->
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
        <h2 class="text-center mb-4">在时间轴上点击相应模块即查看该朝代所有古墓葬</h2>
        <div id="timeline"></div>
    </div>

   
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // 自定义模态框实现
        function showRelicsModal(dynasty, relics) {
            const modal = document.getElementById('relicsModal');
            const modalTitle = modal.querySelector('.custom-modal-title');
            const modalBody = modal.querySelector('.custom-modal-body');
            const modalClose = modal.querySelector('.custom-modal-close');
            const modalOverlay = modal.querySelector('.custom-modal-overlay');
            
            modalTitle.textContent = `${dynasty}时期古墓葬（共${relics.length}件）`;
            modalBody.innerHTML = relics.map(relic => `
                <div class="relic-card">
                    <h6>${relic.name || '未命名古墓葬'}</h6>
                    ${relic.image ? `<img src="./img/${relic.image}" alt="${relic.name}">` : ''}
                    <p class="mt-2 text-muted">
                        <span>批次：${relic.batch || '未知'}</span><br>
                        <span>地址：${relic.address || '地址不详'}</span>
                    </p>
                    ${relic.remarks ? `<p class="text-truncate">${relic.remarks}</p>` : ''}
                </div>
            `).join('');
            
            modal.style.display = 'block';
            
            function closeModal() {
                modal.style.display = 'none';
            }
            
            modalClose.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);
        }

        // 加载朝代文物数据
        const dynastyMap = {
            '夏': '夏朝', '商': '商朝', '周': '周朝', '秦': '秦朝',
            '汉': '汉朝', '三国': '三国时期', '晋': '晋朝', '南北朝': '南北朝',
            '隋': '隋朝', '唐': '唐朝', '宋': '宋朝', '元': '元朝',
            '明': '明朝', '清': '清朝'
        };

        async function loadDynastyRelics(dynasty) {
            const relics = await (await fetch('./json/cultural-relics.json')).json();
            return relics.filter(relic => {
                const rawDynasty = relic.era || '未知';
                return dynastyMap[rawDynasty] === dynasty;
            });
        }

        async function loadDynastyData() {
            const relics = await (await fetch('./json/cultural-relics.json')).json();
            
            // 朝代时间范围数据
            const dynastyPeriods = {
                '夏朝': [-2070, -1600],
                '商朝': [-1600, -1046],
                '周朝': [-1046, -256],
                '秦朝': [-221, -206],
                '汉朝': [-202, 220],
                '三国时期': [220, 280],
                '晋朝': [265, 420],
                '南北朝': [420, 589],
                '隋朝': [581, 618],
                '唐朝': [618, 907],
                '宋朝': [960, 1279],
                '元朝': [1271, 1368],
                '明朝': [1368, 1644],
                '清朝': [1636, 1912]
            };

            // 统计朝代文物数量
            const dynastyCounts = relics.reduce((acc, relic) => {
                const rawDynasty = relic.era || '未知';
                const dynasty = dynastyMap[rawDynasty] || rawDynasty;
                if (dynastyPeriods[dynasty]) {
                    acc[dynasty] = (acc[dynasty] || 0) + 1;
                }
                return acc;
            }, {});

            // 生成时间轴数据
            return Object.entries(dynastyPeriods).map(([dynasty, [start, end]]) => ({
                dynasty: dynasty,
                start: start,
                end: end,
                count: dynastyCounts[dynasty] || 0
            }));
        }

        // 使用D3.js创建时间轴
        loadDynastyData().then(data => {
            const container = document.getElementById('timeline');
            
            // 清除现有内容
            container.innerHTML = '';
            
            // 设置尺寸
            const width = container.clientWidth || 800;
            const height = 200;
            const padding = { top: 20, right: 40, bottom: 60, left: 40 };
            
            // 创建SVG
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // 计算时间范围
            const timeExtent = d3.extent(data, d => d.start).concat(d3.extent(data, d => d.end));
            const minTime = Math.min(...timeExtent);
            const maxTime = Math.max(...timeExtent);
            
            // 创建时间比例尺
            const xScale = d3.scaleLinear()
                .domain([minTime, maxTime])
                .range([padding.left, width - padding.right]);
            
            // 创建Y比例尺（用于条形图）
            const maxCount = d3.max(data, d => d.count);
            const yScale = d3.scaleLinear()
                .domain([0, maxCount])
                .range([height - padding.bottom, padding.top]);
            
            // 创建X轴
            const xAxis = d3.axisBottom(xScale)
                .tickFormat(d => d + '年')
                .ticks(10);
            
            // 添加X轴
            svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0, ${height - padding.bottom})`)
                .call(xAxis)
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end')
                .style('font-size', '10px');
            
            // 添加时间轴线条
            svg.append('line')
                .attr('class', 'timeline-line')
                .attr('x1', padding.left)
                .attr('y1', height - padding.bottom + 5)
                .attr('x2', width - padding.right)
                .attr('y2', height - padding.bottom + 5)
                .style('stroke', '#8B4513')
                .style('stroke-width', 2);
            
            // 添加朝代区块
            const dynastyGroups = svg.selectAll('.dynasty-group')
                .data(data)
                .enter()
                .append('g')
                .attr('class', 'dynasty-group')
                .style('cursor', 'pointer')
                .on('click', async function(event, d) {
                    const relics = await loadDynastyRelics(d.dynasty);
                    showRelicsModal(d.dynasty, relics);
                });
            
            // 添加朝代时间范围矩形
            dynastyGroups.append('rect')
                .attr('x', d => xScale(d.start))
                .attr('y', height - padding.bottom - 10)
                .attr('width', d => xScale(d.end) - xScale(d.start))
                .attr('height', 15)
                .style('fill', '#D2B48C')
                .style('opacity', 0.7)
                .style('stroke', '#8B4513')
                .style('stroke-width', 1);
            
            // 添加朝代名称
            dynastyGroups.append('text')
                .attr('x', d => (xScale(d.start) + xScale(d.end)) / 2)
                .attr('y', height - padding.bottom - 15)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .text(d => d.dynasty);
            
            // 添加文物数量标签
            dynastyGroups.append('text')
                .attr('x', d => (xScale(d.start) + xScale(d.end)) / 2)
                .attr('y', height - padding.bottom + 10)
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .text(d => d.count + '件');
            
            // 添加文物数量条形图
            dynastyGroups.append('rect')
                .attr('x', d => xScale(d.start))
                .attr('y', d => yScale(d.count))
                .attr('width', d => Math.max(2, xScale(d.end) - xScale(d.start)))
                .attr('height', d => height - padding.bottom - yScale(d.count))
                .style('fill', '#8B4513')
                .style('opacity', 0.6);
            
            // 添加悬停效果
            dynastyGroups.on('mouseover', function(event, d) {
                d3.select(this)
                    .selectAll('rect')
                    .style('opacity', 1);
            })
            .on('mouseout', function(event, d) {
                d3.select(this)
                    .selectAll('rect')
                    .style('opacity', d => d3.select(this).select('rect').attr('class') === 'count-bar' ? 0.6 : 0.7);
            });
        }).catch(error => {
            console.error('时间轴数据加载失败:', error);
            alert('数据加载失败，请检查网络连接');
        });
    </script>
    
    <!-- 页脚 -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>京藏古道人文环境时空信息开放平台</h3>
                    <p>元代北京至西藏的驿路文明</p>
                </div>
                <div class="footer-links">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="../index.html">首页</a></li>
                        <li><a href="../index.html#explore">古道探索</a></li>
                        <li><a href="../index.html#map">地图展示</a></li>
                        <li><a href="../index.html#dataset">数据集</a></li>
                        <li><a href="culture.html">文化内涵</a></li>
                        <li><a href="travel.html">旅游攻略</a></li>
                        <li><a href="../index.html#about">关于平台</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h4>联系方式</h4>
                    <p>邮箱：contact@jzgd-platform.org</p>
                    <p>电话：010-12345678</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 京藏古道人文环境时空信息开放平台 版权所有</p>
            </div>
        </div>
    </footer>
    
</body>
</html>

