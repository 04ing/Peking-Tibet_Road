<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古道路线复原与重建 - 京藏古道人文环境时空信息开放平台</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 高德地图API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=fe4e50125495ae9967861058e720c5dd&plugin=AMap.ToolBar,AMap.Scale"></script>
    <!-- 引入D3.js库 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header>
        <div class="container">
            <div class="logo">
                <h1>京藏古道人文环境时空信息开放平台</h1>
                <p>元代北京至西藏的驿路文明</p>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">首页</a></li>
                    <li><a href="index.html#explore" class="active">古道探索</a></li>
                    <li><a href="index.html#map">地图展示</a></li>
                    <li><a href="index.html#dataset">数据集</a></li>
                    <li><a href="index.html#about">关于平台</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 页面标题 -->
    <section class="page-header">
        <div class="container">
            <h1>古道路线复原与重建</h1>
            <p>基于历史文献、考古资料和现代地理信息，重现元代京藏古道的路线网络</p>
        </div>
    </section>

    <!-- 路线复原方法 -->
    <section class="route-method">
        <div class="container">
            <h2>路线复原方法</h2>
            <div class="method-content">
                <div class="method-item">
                    <div class="method-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3>历史文献分析</h3>
                    <p>系统梳理《元史》、《经世大典》、《永乐大典》等历史文献中关于京藏古道的记载，提取路线走向、驿站设置、行程距离等关键信息。</p>
                </div>
                <div class="method-item">
                    <div class="method-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>考古资料整合</h3>
                    <p>收集沿线考古发现的驿站遗址、碑刻、文物等资料，结合实地调查，验证和修正文献记载的路线信息。</p>
                </div>
                <div class="method-item">
                    <div class="method-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <h3>地理信息系统</h3>
                    <p>利用现代GIS技术，结合地形、地貌、水系等自然地理要素，对历史路线进行空间定位和可视化展示。</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 主要路线 -->
    <section class="main-routes">
        <div class="container">
            <h2>主要路线</h2>
            <div class="route-map" style="height: 600px; margin-bottom: 30px;">
                <div id="amap-container" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="route-details">
                <div class="route-section">
                    <h3>北京至大同段</h3>
                    <p>起点为元代大都（今北京），经居庸关、宣德府（今宣化）至大同，全长约500公里，是京藏古道的东端起点段。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>大都（今北京）</li>
                            <li>居庸关</li>
                            <li>宣德府（今宣化）</li>
                            <li>大同</li>
                        </ul>
                    </div>
                </div>
                <div class="route-section">
                    <h3>大同至兰州段</h3>
                    <p>从大同西行，经朔州、代州、太原、汾州、平阳、河中府、同州、华州、京兆府（今西安）、凤翔、秦州至兰州，全长约1500公里。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>大同</li>
                            <li>太原</li>
                            <li>京兆府（今西安）</li>
                            <li>兰州</li>
                        </ul>
                    </div>
                </div>
                <div class="route-section">
                    <h3>兰州至西宁段</h3>
                    <p>从兰州沿黄河西行，经永登、庄浪至西宁，全长约300公里，是进入青藏高原的过渡段。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>兰州</li>
                            <li>永登</li>
                            <li>西宁</li>
                        </ul>
                    </div>
                </div>
                <div class="route-section">
                    <h3>西宁至拉萨段</h3>
                    <p>从西宁西南行，经湟源、多巴、日月山、倒淌河、恰卜恰、共和、兴海、玛多、玉树、昌都、工布江达至拉萨，全长约2000公里，是京藏古道的核心段。</p>
                    <div class="route-stations">
                        <h4>主要驿站：</h4>
                        <ul>
                            <li>西宁</li>
                            <li>玉树</li>
                            <li>昌都</li>
                            <li>拉萨</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 支线网络 -->
    <section class="branch-routes">
        <div class="container">
            <h2>支线网络</h2>
            <p>除主线外，京藏古道还有多条重要支线，构成了完整的交通网络：</p>
            <div class="branch-grid">
                <div class="branch-item">
                    <h3>大同至张家口支线</h3>
                    <p>连接大同与张家口，是京藏古道与北方草原丝路的交汇点。</p>
                </div>
                <div class="branch-item">
                    <h3>西宁至河西走廊支线</h3>
                    <p>连接西宁与河西走廊，是京藏古道与丝绸之路的连接通道。</p>
                </div>
                <div class="branch-item">
                    <h3>玉树至康定支线</h3>
                    <p>连接玉树与康定，是京藏古道与川藏道的连接通道。</p>
                </div>
                <div class="branch-item">
                    <h3>拉萨至日喀则支线</h3>
                    <p>连接拉萨与日喀则，是京藏古道向西藏南部延伸的重要支线。</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 重要节点 -->
    <section class="key-nodes">
        <div class="container">
            <h2>重要节点</h2>
            <div class="nodes-grid">
                <div class="node-item">
                    <h3>居庸关</h3>
                    <p>位于北京西北，是京藏古道出京的第一重要关口，素有"天下第一雄关"之称。</p>
                </div>
                <div class="node-item">
                    <h3>大同</h3>
                    <p>元代称为大同路，是京藏古道的重要枢纽，连接中原与草原。</p>
                </div>
                <div class="node-item">
                    <h3>兰州</h3>
                    <p>元代称为兰州路，是京藏古道进入西北地区的重要节点。</p>
                </div>
                <div class="node-item">
                    <h3>西宁</h3>
                    <p>元代称为西宁州，是京藏古道进入青藏高原的门户。</p>
                </div>
                <div class="node-item">
                    <h3>玉树</h3>
                    <p>元代称为朵甘思，是京藏古道在青藏高原的重要驿站。</p>
                </div>
                <div class="node-item">
                    <h3>拉萨</h3>
                    <p>元代称为萨斯迦，是京藏古道的终点，西藏地区的政治、宗教中心。</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 路线可视化 -->
    <section class="route-visualization">
        <div class="container">
            <h2>路线可视化</h2>
            <p>基于D3.js的平滑动态路线可视化，展示京藏古道的完整路线网络：</p>
            <div id="d3-route-container" style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px;"></div>
        </div>
    </section>

    <!-- 复原成果 -->
    <section class="route-results">
        <div class="container">
            <h2>复原成果</h2>
            <div class="results-content">
                <div class="result-item">
                    <h3>路线地图</h3>
                    <p>基于历史文献和考古资料，复原了元代京藏古道的完整路线图，包括主线和支线，共计约4300公里。</p>
                </div>
                <div class="result-item">
                    <h3>驿站体系</h3>
                    <p>复原了沿线100余个驿站的位置和功能，构建了完整的驿站体系数据库。</p>
                </div>
                <div class="result-item">
                    <h3>行程指南</h3>
                    <p>根据历史文献记载，复原了从北京至拉萨的详细行程，包括每日行程距离、宿营地和重要景观。</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 参考文献 -->
    <section class="references">
        <div class="container">
            <h2>参考文献</h2>
            <ul>
                <li>《元史》，中华书局，1976年</li>
                <li>《经世大典》辑本，中华书局，1992年</li>
                <li>《永乐大典》残卷，中华书局，1986年</li>
                <li>陈得芝：《元代交通史》，人民交通出版社，2003年</li>
                <li>王颋：《元代驿站制度研究》，上海古籍出版社，2005年</li>
                <li>西藏自治区交通厅：《西藏古近代交通史》，人民交通出版社，1994年</li>
            </ul>
        </div>
    </section>

    <!-- 页脚 -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>京藏古道人文环境时空信息开放平台</h3>
                    <p>元代北京至西藏的驿路文明</p>
                </div>
                <div class="footer-links">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="index.html">首页</a></li>
                        <li><a href="index.html#explore">古道探索</a></li>
                        <li><a href="index.html#map">地图展示</a></li>
                        <li><a href="index.html#dataset">数据集</a></li>
                        <li><a href="index.html#about">关于平台</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h4>联系方式</h4>
                    <p>邮箱：contact@jzgd-platform.org</p>
                    <p>电话：010-12345678</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 京藏古道人文环境时空信息开放平台 版权所有</p>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        // 检查高德地图API是否加载成功
        if (typeof AMap === 'undefined') {
            console.error('高德地图API加载失败');
            document.getElementById('amap-container').innerHTML = 
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">高德地图API加载失败，请检查网络连接</div>';
        } else {
            console.log('高德地图API加载成功');
            
            // 检查插件是否加载成功
            console.log('AMap.ToolBar是否可用:', typeof AMap.ToolBar !== 'undefined');
            console.log('AMap.Scale是否可用:', typeof AMap.Scale !== 'undefined');
            
            // 初始化高德地图
            var map = new AMap.Map('amap-container', {
                center: [103.834303, 36.061101], // 兰州附近作为中心点
                zoom: 5,
                mapStyle: 'amap://styles/whitesmoke'
            });
            
            console.log('地图初始化成功:', map);
            
            // 检查文件路径是否正确
            console.log('当前页面URL:', window.location.href);
            
            // 从JSON文件加载路线数据
            fetch('json/route-data.json')
                .then(response => {
                    console.log('fetch响应状态:', response.status);
                    if (!response.ok) {
                        throw new Error('HTTP错误，状态码: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('路线数据加载成功:', data);
                    
                    // 检查数据结构
                    console.log('nodes长度:', data.nodes ? data.nodes.length : '未定义');
                    console.log('mainRoute长度:', data.mainRoute ? data.mainRoute.length : '未定义');
                    console.log('branchRoutes长度:', data.branchRoutes ? data.branchRoutes.length : '未定义');
                    
                    // 获取数据
                    const nodes = data.nodes;
                    const mainRoute = data.mainRoute;
                    const branchRoutes = data.branchRoutes;
                    
                    // 绘制主要路线
                    console.log('开始绘制主要路线...');
                    var mainPolyline = new AMap.Polyline({
                        path: mainRoute,
                        strokeColor: '#1890ff',
                        strokeWeight: 6,
                        strokeOpacity: 0.8,
                        strokeStyle: 'solid'
                    });
                    
                    // 为主要路线添加点击事件
                    mainPolyline.on('click', function() {
                        var infoWindow = new AMap.InfoWindow({
                            content: '<h3>京藏古道主线</h3><p>元代北京至西藏的主要驿路，全长约4300公里，连接了中原与西藏地区。</p>',
                            offset: new AMap.Pixel(0, -30)
                        });
                        infoWindow.open(map, mainRoute[Math.floor(mainRoute.length / 2)]);
                    });
                    
                    mainPolyline.setMap(map);
                    console.log('主要路线绘制完成:', mainPolyline);
                    
                    // 绘制支线
                    console.log('开始绘制支线...');
                    branchRoutes.forEach(function(branch, index) {
                        console.log('绘制支线', index + 1, branch.name);
                        var polyline = new AMap.Polyline({
                            path: branch.path,
                            strokeColor: '#52c41a',
                            strokeWeight: 4,
                            strokeOpacity: 0.6,
                            strokeStyle: 'dashed'
                        });
                        
                        // 为支线添加点击事件
                        polyline.on('click', function() {
                            var infoWindow = new AMap.InfoWindow({
                                content: '<h3>' + branch.name + '</h3><p>' + branch.desc + '</p>',
                                offset: new AMap.Pixel(0, -30)
                            });
                            infoWindow.open(map, branch.path[Math.floor(branch.path.length / 2)]);
                        });
                        
                        polyline.setMap(map);
                        console.log('支线', index + 1, '绘制完成:', polyline);
                    });
                    console.log('所有支线绘制完成');
                    
                    // 添加节点标记
                    console.log('开始添加节点标记...');
                    nodes.forEach(function(node, index) {
                        console.log('添加节点标记', index + 1, node.name);
                        var marker = new AMap.Marker({
                            position: [node.lng, node.lat],
                            title: node.name,
                            icon: new AMap.Icon({
                                size: new AMap.Size(30, 30),
                                image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                                imageSize: new AMap.Size(30, 30)
                            })
                        });
                        
                        // 信息窗口
                        var infoWindow = new AMap.InfoWindow({
                            content: '<h3>' + node.name + '</h3><p>' + node.desc + '</p>',
                            offset: new AMap.Pixel(0, -30)
                        });
                        
                        // 点击标记打开信息窗口
                        marker.on('click', function() {
                            infoWindow.open(map, marker.getPosition());
                        });
                        
                        marker.setMap(map);
                        console.log('节点标记', index + 1, '添加完成:', marker);
                    });
                    console.log('所有节点标记添加完成');
                    
                    // 添加控件
                    console.log('开始添加控件...');
                    if (typeof AMap.ToolBar !== 'undefined') {
                        map.addControl(new AMap.ToolBar({
                            position: 'RB'
                        }));
                        console.log('ToolBar控件添加完成');
                    } else {
                        console.warn('AMap.ToolBar不可用，跳过添加');
                    }
                    
                    if (typeof AMap.Scale !== 'undefined') {
                        map.addControl(new AMap.Scale({
                            position: 'RB'
                        }));
                        console.log('Scale控件添加完成');
                    } else {
                        console.warn('AMap.Scale不可用，跳过添加');
                    }
                    console.log('所有控件添加完成');
                    
                    // 初始化D3.js路线可视化
                    initD3RouteVisualization(data);
                })
                .catch(error => {
                    console.error('加载路线数据失败:', error);
                    console.error('错误详细信息:', error.message);
                    // 显示错误信息
                    document.getElementById('amap-container').innerHTML = 
                        '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">数据加载失败，请检查控制台错误信息</div>';
                });
        }
        
        // 使用D3.js初始化路线可视化
        function initD3RouteVisualization(data) {
            console.log('初始化D3.js路线可视化...');
            
            const container = document.getElementById('d3-route-container');
            const width = container.clientWidth || 800;
            const height = container.clientHeight || 600;
            const padding = { top: 20, right: 20, bottom: 20, left: 20 };
            
            // 清除现有内容
            container.innerHTML = '';
            
            // 创建SVG
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // 提取所有经纬度数据用于计算投影范围
            const allCoords = [];
            data.mainRoute.forEach(coord => allCoords.push([coord[0], coord[1]]));
            data.branchRoutes.forEach(branch => {
                branch.path.forEach(coord => allCoords.push([coord[0], coord[1]]));
            });
            data.nodes.forEach(node => allCoords.push([node.lng, node.lat]));
            
            // 创建地理投影
            const projection = d3.geoMercator()
                .fitExtent([[padding.left, padding.top], [width - padding.right, height - padding.bottom]], {
                    type: 'FeatureCollection',
                    features: [{
                        type: 'Feature',
                        geometry: {
                            type: 'MultiPoint',
                            coordinates: allCoords
                        }
                    }]
                });
            
            // 创建路径生成器
            const path = d3.geoPath().projection(projection);
            
            // 创建线条生成器（用于平滑曲线）
            const line = d3.line()
                .x(d => projection([d[0], d[1]])[0])
                .y(d => projection([d[0], d[1]])[1])
                .curve(d3.curveCatmullRom.alpha(0.5));
            
            // 添加背景
            svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .style('fill', '#f5f5f5');
            
            // 添加支线
            data.branchRoutes.forEach((branch, index) => {
                const branchPath = svg.append('path')
                    .datum(branch.path)
                    .attr('d', line)
                    .style('fill', 'none')
                    .style('stroke', '#52c41a')
                    .style('stroke-width', 3)
                    .style('stroke-opacity', 0)
                    .style('stroke-dasharray', '5,5');
                
                // 添加动态显示效果
                const length = branchPath.node().getTotalLength();
                branchPath
                    .attr('stroke-dasharray', length)
                    .attr('stroke-dashoffset', length)
                    .transition()
                    .duration(2000)
                    .delay(index * 500)
                    .style('stroke-opacity', 0.6)
                    .attr('stroke-dashoffset', 0);
                
                // 添加点击事件
                branchPath.on('click', function(event) {
                    // 创建提示框
                    const tooltip = d3.select('body')
                        .append('div')
                        .attr('class', 'tooltip')
                        .style('position', 'absolute')
                        .style('background-color', 'rgba(0, 0, 0, 0.8)')
                        .style('color', 'white')
                        .style('padding', '8px 12px')
                        .style('border-radius', '4px')
                        .style('font-size', '12px')
                        .style('pointer-events', 'none')
                        .style('z-index', 9999)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px')
                        .text(`${branch.name}: ${branch.desc}`);
                    
                    // 3秒后移除提示框
                    setTimeout(() => tooltip.remove(), 3000);
                });
            });
            
            // 添加主线
            const mainPath = svg.append('path')
                .datum(data.mainRoute)
                .attr('d', line)
                .style('fill', 'none')
                .style('stroke', '#1890ff')
                .style('stroke-width', 5)
                .style('stroke-opacity', 0);
            
            // 添加动态显示效果
            const mainLength = mainPath.node().getTotalLength();
            mainPath
                .attr('stroke-dasharray', mainLength)
                .attr('stroke-dashoffset', mainLength)
                .transition()
                .duration(3000)
                .delay(1000)
                .style('stroke-opacity', 0.8)
                .attr('stroke-dashoffset', 0)
                .on('end', function() {
                    // 路线显示完成后，添加马匹动画
                    console.log('路线显示完成，准备开始马匹动画');
                    // 直接调用马匹动画，不依赖数据传递
                    animateHorse();
                });
            
            // 添加主线点击事件
            mainPath.on('click', function(event) {
                // 创建提示框
                const tooltip = d3.select('body')
                    .append('div')
                    .attr('class', 'tooltip')
                    .style('position', 'absolute')
                    .style('background-color', 'rgba(0, 0, 0, 0.8)')
                    .style('color', 'white')
                    .style('padding', '8px 12px')
                    .style('border-radius', '4px')
                    .style('font-size', '12px')
                    .style('pointer-events', 'none')
                    .style('z-index', 9999)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px')
                    .text('京藏古道主线: 元代北京至西藏的主要驿路，全长约4300公里');
                
                // 3秒后移除提示框
                setTimeout(() => tooltip.remove(), 3000);
            });
            
            // 添加节点
            const nodes = svg.selectAll('.node')
                .data(data.nodes)
                .enter()
                .append('circle')
                .attr('class', 'node')
                .attr('cx', d => projection([d.lng, d.lat])[0])
                .attr('cy', d => projection([d.lng, d.lat])[1])
                .attr('r', 0)
                .style('fill', '#ff7875')
                .style('stroke', '#fff')
                .style('stroke-width', 2)
                .style('opacity', 0);
            
            // 添加节点动态显示效果
            nodes.transition()
                .duration(500)
                .delay((d, i) => 2000 + i * 100)
                .attr('r', 5)
                .style('opacity', 1);
            
            // 添加节点标签
            const labels = svg.selectAll('.node-label')
                .data(data.nodes)
                .enter()
                .append('text')
                .attr('class', 'node-label')
                .attr('x', d => projection([d.lng, d.lat])[0] + 10)
                .attr('y', d => projection([d.lng, d.lat])[1] + 4)
                .style('font-size', '10px')
                .style('fill', '#333')
                .style('opacity', 0)
                .text(d => d.name);
            
            // 添加标签动态显示效果
            labels.transition()
                .duration(500)
                .delay((d, i) => 2500 + i * 100)
                .style('opacity', 0.7);
            
            // 添加节点悬停效果
            nodes.on('mouseover', function(event, d) {
                d3.select(this)
                    .attr('r', 8)
                    .style('fill', '#ff4d4f');
                
                // 创建提示框
                const tooltip = d3.select('body')
                    .append('div')
                    .attr('class', 'tooltip')
                    .style('position', 'absolute')
                    .style('background-color', 'rgba(0, 0, 0, 0.8)')
                    .style('color', 'white')
                    .style('padding', '8px 12px')
                    .style('border-radius', '4px')
                    .style('font-size', '12px')
                    .style('pointer-events', 'none')
                    .style('z-index', 9999)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px')
                    .html(`<strong>${d.name}</strong><br>${d.desc}`);
            })
            .on('mouseout', function() {
                d3.select(this)
                    .attr('r', 5)
                    .style('fill', '#ff7875');
                
                // 移除提示框
                d3.selectAll('.tooltip').remove();
            });
            
            // 马匹动画函数
            function animateHorse() {
                console.log('开始马匹动画...');
                console.log('数据是否可用:', data);
                console.log('主线数据长度:', data.mainRoute.length);
                
                // 直接使用data.mainRoute
                const route = data.mainRoute;
                
                // 创建马匹图标
                const horse = svg.append('g')
                    .attr('class', 'horse')
                    .style('opacity', 1); // 立即显示，不使用过渡
                
                // 使用更形象、更大的马匹图标
                const horseGroup = horse.append('g')
                    .attr('transform', 'scale(4)'); // 进一步增大尺寸
                
                // 绘制马头
                horseGroup.append('circle')
                    .attr('cx', 0)
                    .attr('cy', 0)
                    .attr('r', 5)
                    .style('fill', '#8B4513')
                    .style('stroke', '#000')
                    .style('stroke-width', 1);
                
                // 绘制马身
                horseGroup.append('ellipse')
                    .attr('cx', 15)
                    .attr('cy', 0)
                    .attr('rx', 10)
                    .attr('ry', 5)
                    .style('fill', '#8B4513')
                    .style('stroke', '#000')
                    .style('stroke-width', 1);
                
                // 绘制马腿
                const legs = [[10, 5], [18, 5], [10, 8], [18, 8]];
                legs.forEach((leg, index) => {
                    horseGroup.append('line')
                        .attr('x1', leg[0])
                        .attr('y1', 0)
                        .attr('x2', leg[0])
                        .attr('y2', leg[1])
                        .style('stroke', '#8B4513')
                        .style('stroke-width', 2);
                });
                
                // 绘制马尾
                horseGroup.append('path')
                    .attr('d', 'M25,0 Q30,-5 28,5')
                    .style('fill', 'none')
                    .style('stroke', '#8B4513')
                    .style('stroke-width', 2);
                
                // 绘制马耳
                horseGroup.append('path')
                    .attr('d', 'M-3,-5 L-5,-10 L-1,-10 Z')
                    .style('fill', '#8B4513');
                horseGroup.append('path')
                    .attr('d', 'M3,-5 L5,-10 L1,-10 Z')
                    .style('fill', '#8B4513');
                
                // 绘制马眼
                horseGroup.append('circle')
                    .attr('cx', -3)
                    .attr('cy', -2)
                    .attr('r', 1)
                    .style('fill', 'white');
                horseGroup.append('circle')
                    .attr('cx', 3)
                    .attr('cy', -2)
                    .attr('r', 1)
                    .style('fill', 'white');
                
                // 确保路线点数组创建正确
                console.log('路线点数量:', route.length);
                
                // 直接使用路线数据点，不使用路径长度计算
                const routePoints = route.map(coord => {
                    const [x, y] = projection([coord[0], coord[1]]);
                    return { x, y };
                });
                
                console.log('动画点数量:', routePoints.length);
                console.log('第一个点坐标:', routePoints[0]);
                
                // 设置初始位置
                const firstPoint = routePoints[0];
                horse.attr('transform', `translate(${firstPoint.x}, ${firstPoint.y}) rotate(0)`);
                console.log('马匹初始位置设置完成');
                
                // 立即开始动画，不等待过渡结束
                let i = 0;
                function moveHorse() {
                    if (i < routePoints.length) {
                        const point = routePoints[i];
                        console.log('移动到点:', i, point);
                        
                        // 计算方向
                        let angle = 0;
                        if (i > 0) {
                            const prevPoint = routePoints[i - 1];
                            angle = Math.atan2(point.y - prevPoint.y, point.x - prevPoint.x) * 180 / Math.PI;
                        }
                        
                        // 直接更新马匹位置和方向，不使用transition
                        horse.attr('transform', `translate(${point.x}, ${point.y}) rotate(${angle})`);
                        
                        i++;
                        // 减慢动画速度
                        setTimeout(moveHorse, 1000); // 进一步减慢
                    } else {
                        // 动画结束，隐藏马匹
                        horse.style('opacity', 0);
                        console.log('马匹动画结束');
                    }
                }
                
                // 立即开始动画
                console.log('准备开始移动动画');
                moveHorse();
            }
            
            // 获取路径上的点
            function getPointAtLength(pathString, progress) {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathString);
                const length = path.getTotalLength();
                const point = path.getPointAtLength(length * progress);
                return point;
            }
            
            // 添加响应式调整
            window.addEventListener('resize', function() {
                const newWidth = container.clientWidth || 800;
                const newHeight = container.clientHeight || 600;
                
                svg.attr('width', newWidth).attr('height', newHeight);
                
                // 重新计算投影
                projection.fitExtent([[padding.left, padding.top], [newWidth - padding.right, newHeight - padding.bottom]], {
                    type: 'FeatureCollection',
                    features: [{
                        type: 'Feature',
                        geometry: {
                            type: 'MultiPoint',
                            coordinates: allCoords
                        }
                    }]
                });
                
                // 更新所有元素位置
                svg.selectAll('path').attr('d', function(d) {
                    // 只处理有数据绑定的路径元素
                    if (d && d[0] && d[0][0]) {
                        return line(d);
                    }
                    // 对于没有数据绑定的路径（如马匹图标），保持原样
                    return null;
                });
                
                svg.selectAll('.node')
                    .attr('cx', d => projection([d.lng, d.lat])[0])
                    .attr('cy', d => projection([d.lng, d.lat])[1]);
                
                svg.selectAll('.node-label')
                    .attr('x', d => projection([d.lng, d.lat])[0] + 10)
                    .attr('y', d => projection([d.lng, d.lat])[1] + 4);
            });
            
            console.log('D3.js路线可视化初始化完成');
        }
    </script>
</body>
</html>