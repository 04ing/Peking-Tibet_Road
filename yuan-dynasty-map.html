<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>元朝京藏古道地图</title>
    <!-- 统一使用Leaflet 1.9.4版本 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- 引入ECharts库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* 自定义样式 */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #8B4513;
            color: white;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .back-button, .comparison-button {
            background-color: #D2B48C;
            color: #8B4513;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .back-button:hover, .comparison-button:hover {
            background-color: #CD853F;
        }
        
        .top-bar-title {
            text-align: center;
            flex: 1;
        }
        
        .main-title {
            margin: 0;
            font-size: 24px;
        }
        
        .subtitle {
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .map-container {
            width: 100%;
            max-width: 1200px;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            width: 100%;
            max-width: 1200px;
            height: 300px;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dynasty-container {
            width: 100%;
            max-width: 1200px;
            margin-bottom: 30px;
        }
        
        .dynasty-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #8B4513;
            text-align: center;
        }
        
        /* 错误提示样式 */
        .error-message {
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- 顶部栏 -->
    <div class="top-bar">
        <button class="back-button" id="back-button">返回</button>
        <div class="top-bar-title">
            <h1 class="main-title">元朝京藏古道地图</h1>
            <p class="subtitle">基于元代北京至西藏驿路的历史地理信息可视化</p>
        </div>
        <button class="comparison-button" id="info-button">地图信息</button>
    </div>
    
    <div class="container">
        <!-- 元朝地图 -->
        <div class="dynasty-container">
            <div class="dynasty-title">元朝京藏古道</div>
            <div id="yuan-map" class="map-container"></div>
            <div id="yuan-chart" class="chart-container"></div>
        </div>
    </div>
    
    <!-- 地图信息弹窗 -->
    <div class="comparison-modal" id="info-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999;">
        <div class="comparison-modal-content" style="background-color: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
            <div class="comparison-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="comparison-modal-title" style="margin: 0; color: #8B4513;">地图信息</h3>
                <button class="close-modal-btn" id="close-modal-btn" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div class="comparison-modal-body">
                <div class="dynasty-card">
                    <h4 style="color: #8B4513;">元朝京藏古道</h4>
                    <div class="dynasty-info">
                        <strong>时期：</strong>1271-1368年<br>
                        <strong>特点：</strong>建立了完善的驿站制度，连接北京与西藏<br>
                        <strong>主要路线：</strong>北京-河北-山西-内蒙古-宁夏-甘肃-青海-西藏<br>
                        <strong>历史意义：</strong>促进了中原与西藏的政治、经济、文化交流
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <h4 style="color: #8B4513;">地图数据说明</h4>
                    <p>本地图使用ESRI底图服务，并叠加了元朝历史地图和京藏古道路线数据。地图数据来源于历史文献、考古资料和现代地理信息系统。</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        var yuanMap;
        var yuanHistoricalLayer;
        var jingzangRouteLayer;
        var yuanChart;
        
        // 初始化地图
        function initMaps() {
            console.log('初始化地图...');
            try {
                // 初始化元朝地图
                if (!document.getElementById('yuan-map')) {
                    console.error('找不到yuan-map容器');
                    showGlobalError('找不到元朝地图容器');
                } else {
                    yuanMap = L.map('yuan-map').setView([35.86166, 104.195397], 4);
                    initMapBaseLayer(yuanMap, 'yuan');
                }
                
                console.log('地图初始化完成');
            } catch (error) {
                console.error('地图初始化异常:', error);
                showGlobalError('地图初始化失败: ' + error.message);
            }
        }

        // 显示全局错误信息
        function showGlobalError(message) {
            var errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.9)';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '10px 20px';
            errorDiv.style.borderRadius = '4px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.fontWeight = 'bold';
            errorDiv.innerHTML = message;
            
            document.body.appendChild(errorDiv);
            
            // 5秒后自动消失
            setTimeout(function() {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 5000);
        }

        // 初始化地图底图
        function initMapBaseLayer(map, dynasty) {
            console.log('初始化地图底图:', dynasty);
            
            // 创建自定义的瓦片图层类，增强错误处理
            var EnhancedTileLayer = L.TileLayer.extend({
                initialize: function(url, options) {
                    options = L.Util.extend({
                        errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        tileSize: 256,
                        maxZoom: 18,
                        minZoom: 0,
                        noWrap: false,
                        zoomOffset: 0,
                        zoomReverse: false,
                        opacity: 1,
                        zIndex: 1,
                        unloadInvisibleTiles: true,
                        updateWhenIdle: false,
                        bounds: null
                    }, options);
                    
                    L.TileLayer.prototype.initialize.call(this, url, options);
                },
                
                createTile: function(coords, done) {
                    var tile = document.createElement('img');
                    
                    tile.onload = function() {
                        done(null, tile);
                    };
                    
                    tile.onerror = function() {
                        // 静默处理错误，不显示错误信息
                        done(null, tile);
                    };
                    
                    tile.src = this.getTileUrl(coords);
                    
                    // 添加超时处理
                    setTimeout(function() {
                        if (tile && !tile.complete) {
                            // 超时后不显示错误，使用默认的errorTileUrl
                            tile.src = this.options.errorTileUrl;
                        }
                    }.bind(this), 10000); // 10秒超时
                    
                    return tile;
                }
            });
            
            // 添加ESRI卫星底图
            var satelliteLayer = new EnhancedTileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
            }).addTo(map);
            
            // 添加备用底图
            var osmLayer = new EnhancedTileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
            });
            
            // 定义基础图层控制
            var baseLayers = {
                'ESRI卫星底图': satelliteLayer,
                'OpenStreetMap底图': osmLayer
            };
            
            // 定义覆盖层
            var overlays = {};
            
            // 历史地图瓦片图层URL
            var historicalLayerUrl = '';
            
            // 创建元朝历史地图图层作为覆盖层
            historicalLayerUrl = 'https://gis.sinica.edu.tw/ccts/file-exists.php?img=ad1330-png-'; // 元朝地图的瓦片URL
            yuanHistoricalLayer = new EnhancedTileLayer(historicalLayerUrl + '{z}-{x}-{y}', {
                maxNativeZoom: 15, // 降低最大缩放级别，减少瓦片加载量
                maxZoom: 18,
                attribution: '中央研究院人社中心GIS專題中心',
                opacity: 0.9,
                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                updateWhenIdle: true, // 当地图空闲时才更新瓦片，减少并发请求
                unloadInvisibleTiles: true // 卸载不可见的瓦片，减少内存使用
            });
            
            // 尝试添加历史地图图层，但不强制要求成功
            try {
                yuanHistoricalLayer.addTo(map);
                overlays['元朝历史地图'] = yuanHistoricalLayer;
            } catch (error) {
                console.warn('添加元朝历史地图图层失败:', error);
                // 不显示错误，继续使用其他图层
            }
            
            // 添加图层控制（包含基础图层和覆盖层）
            L.control.layers(baseLayers, overlays).addTo(map);
            
            // 添加错误处理
            function addTileErrorHandling(layer, layerName) {
                if (layer && layer.on) {
                    layer.on('tileerror', function(error) {
                        // 静默处理瓦片错误，不显示错误信息
                        console.log(`${layerName}瓦片加载失败，使用默认瓦片`);
                    });
                    
                    layer.on('load', function() {
                        console.log(`${layerName}地图图层加载完成`);
                    });
                }
            }
            
            // 为图层添加错误处理
            addTileErrorHandling(satelliteLayer, 'ESRI卫星底图');
            addTileErrorHandling(osmLayer, 'OpenStreetMap底图');
            if (yuanHistoricalLayer) {
                addTileErrorHandling(yuanHistoricalLayer, '元朝历史地图');
            }
            
            // 检查瓦片服务器可访问性（异步检查，不阻塞地图加载）
            if (historicalLayerUrl) {
                setTimeout(function() {
                    checkTileServerAccess(historicalLayerUrl, map, '元朝');
                }, 1000);
            }
            
            // 加载京藏古道路线数据
            loadJingzangRouteData(map);
        }

        // 加载京藏古道路线数据
        function loadJingzangRouteData(map) {
            console.log('尝试加载京藏古道路线数据...');
            
            // 从JSON文件加载数据
            fetch('json/route-data.json')
                .then(response => response.json())
                .then(data => {
                    console.log('路线数据加载成功:', data);
                    
                    // 构建GeoJSON格式的数据
                    var features = [];
                    
                    // 添加主线
                    features.push({
                        type: 'Feature',
                        properties: {
                            name: '京藏古道主线',
                            description: '元代北京至西藏的主要驿路'
                        },
                        geometry: {
                            type: 'LineString',
                            coordinates: data.mainRoute
                        }
                    });
                    
                    // 添加支线
                    data.branchRoutes.forEach(function(branch, index) {
                        features.push({
                            type: 'Feature',
                            properties: {
                                name: branch.name,
                                description: branch.desc
                            },
                            geometry: {
                                type: 'LineString',
                                coordinates: branch.path
                            }
                        });
                    });
                    
                    // 添加节点标记
                    data.nodes.forEach(function(node) {
                        var marker = L.marker([node.lat, node.lng])
                            .bindPopup('<b>' + node.name + '</b><br>' + node.desc);
                        marker.addTo(map);
                    });
                    
                    // 创建GeoJSON数据结构
                    var jingzangRouteData = {
                        type: 'FeatureCollection',
                        features: features
                    };
                    
                    // 创建路线图层
                    jingzangRouteLayer = L.geoJSON(jingzangRouteData, {
                        style: function(feature) {
                            // 主线使用不同的样式
                            if (feature.properties.name === '京藏古道主线') {
                                return {
                                    color: '#8B4513',
                                    weight: 6,
                                    opacity: 0.9,
                                    dashArray: '5, 5'
                                };
                            } else {
                                // 支线使用不同的样式
                                return {
                                    color: '#CD853F',
                                    weight: 4,
                                    opacity: 0.7,
                                    dashArray: '10, 10'
                                };
                            }
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties && feature.properties.name) {
                                layer.bindPopup('<b>' + feature.properties.name + '</b><br>' + feature.properties.description);
                            }
                        }
                    }).addTo(map);
                    
                    // 更新图表数据
                    updateChart(data);
                    
                    console.log('京藏古道路线数据加载完成');
                })
                .catch(error => {
                    console.error('加载路线数据失败:', error);
                    showGlobalError('数据加载失败，请刷新页面重试');
                });
        }
        
        // 更新图表数据
        function updateChart(data) {
            console.log('更新图表数据...');
            
            // 统计各省份的节点数量
            var provinceStats = {
                '北京': 0,
                '河北': 0,
                '山西': 0,
                '内蒙古': 0,
                '宁夏': 0,
                '甘肃': 0,
                '青海': 0,
                '西藏': 0
            };
            
            // 简单的省份归属判断（基于经纬度）
            data.nodes.forEach(function(node) {
                var lng = node.lng;
                var lat = node.lat;
                
                if (lng > 115 && lat > 39) provinceStats['北京']++;
                else if (lng > 114 && lat > 38) provinceStats['河北']++;
                else if (lng > 111 && lat > 36) provinceStats['山西']++;
                else if (lng > 108 && lat > 40) provinceStats['内蒙古']++;
                else if (lng > 105 && lat > 37) provinceStats['宁夏']++;
                else if (lng > 100 && lat > 35) provinceStats['甘肃']++;
                else if (lng > 95 && lat > 32) provinceStats['青海']++;
                else if (lng < 95 || lat < 32) provinceStats['西藏']++;
            });
            
            // 过滤掉数量为0的省份
            var filteredStats = {};
            for (var province in provinceStats) {
                if (provinceStats[province] > 0) {
                    filteredStats[province] = provinceStats[province];
                }
            }
            
            // 更新图表
            if (yuanChart) {
                var provinces = Object.keys(filteredStats);
                var stationCounts = Object.values(filteredStats);
                
                yuanChart.setOption({
                    xAxis: {
                        data: provinces
                    },
                    series: [
                        {
                            data: stationCounts,
                            type: 'bar',
                            itemStyle: {
                                color: '#8B4513'
                            }
                        },
                        {
                            data: stationCounts,
                            type: 'line',
                            smooth: true,
                            lineStyle: {
                                color: '#8B4513',
                                width: 3
                            },
                            symbol: 'circle',
                            symbolSize: 8,
                            itemStyle: {
                                color: '#8B4513',
                                borderColor: '#fff',
                                borderWidth: 2
                            }
                        }
                    ]
                });
                
                console.log('图表数据更新完成');
            }
        }

        // 检查瓦片服务器可访问性
        function checkTileServerAccess(url, map, dynasty) {
            console.log('检查瓦片服务器可访问性:', url);
            
            // 设置超时时间
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
            
            fetch(url + '0/0/0', { signal: controller.signal }) // 尝试加载最顶层瓦片
                .then(response => {
                    clearTimeout(timeoutId);
                    if (response.ok) {
                        console.log('瓦片服务器可访问:', url);
                    } else {
                        console.log('瓦片服务器响应异常:', url, response.status);
                        // 不显示错误，继续使用其他图层
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.log('瓦片服务器访问超时:', url);
                    } else {
                        console.log('瓦片服务器访问失败:', url, error.message);
                    }
                    // 不显示错误，继续使用其他图层
                });
        }

        // 初始化图表
        function initCharts() {
            console.log('初始化图表...');
            try {
                // 初始化元朝地图相关图表
                yuanChart = echarts.init(document.getElementById('yuan-chart'));
                
                // 设置图表配置
                var option = {
                    title: {
                        text: '京藏古道驿站分布',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: ['北京', '河北', '山西', '内蒙古', '宁夏', '甘肃', '青海', '西藏']
                    },
                    yAxis: {
                        type: 'value',
                        name: '驿站数量'
                    },
                    series: [
                        {
                            data: [15, 12, 18, 25, 10, 20, 15, 8],
                            type: 'bar',
                            itemStyle: {
                                color: '#8B4513'
                            }
                        },
                        {
                            data: [15, 12, 18, 25, 10, 20, 15, 8],
                            type: 'line',
                            smooth: true,
                            lineStyle: {
                                color: '#8B4513',
                                width: 3
                            },
                            symbol: 'circle',
                            symbolSize: 8,
                            itemStyle: {
                                color: '#8B4513',
                                borderColor: '#fff',
                                borderWidth: 2
                            }
                        }
                    ]
                };
                
                yuanChart.setOption(option);
                
                // 添加响应式调整
                window.addEventListener('resize', function() {
                    if (yuanChart) yuanChart.resize();
                });
                
                console.log('图表初始化完成');
            } catch (error) {
                console.error('图表初始化异常:', error);
                showGlobalError('图表初始化失败: ' + error.message);
            }
        }

        // 页面加载完成后初始化
        window.onload = function() {
            console.log('页面加载完成，开始初始化...');
            // 检查是否加载了Leaflet库
            if (typeof L === 'undefined') {
                console.error('Leaflet库未加载成功！');
                showGlobalError('地图库加载失败，请刷新页面重试。');
                return;
            }
            
            try {
                console.log('初始化地图...');
                initMaps();
                console.log('初始化图表...');
                initCharts();
                
                // 添加顶部栏按钮事件监听
                document.getElementById('back-button').addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
                
                // 地图信息弹窗控制
                const infoModal = document.getElementById('info-modal');
                const infoButton = document.getElementById('info-button');
                const closeModalButton = document.getElementById('close-modal-btn');
                
                infoButton.addEventListener('click', function() {
                    infoModal.style.display = 'flex';
                });
                
                closeModalButton.addEventListener('click', function() {
                    infoModal.style.display = 'none';
                });
                
                // 点击弹窗外部关闭弹窗
                window.addEventListener('click', function(event) {
                    if (event.target === infoModal) {
                        infoModal.style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('初始化异常:', error);
                showGlobalError('初始化失败: ' + error.message);
            }
        };
    </script>
</body>
</html>